generator client {
  provider = "prisma-client-js"
}

//NÃO TIREM OS COMETÁRIOS ELES DOCUMENTAM AS ALTERAÇÕES E FUNCIONALIDADES IMPORTANTES 

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Participante {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  even3Id      Int    @unique
  nome         String
  email        String @unique
  senha        String? 
  role         String @default("user") // "user" ou "admin"

  // Campos de perfil pós-cadastro
  tipoUsuario     String? // "publico_externo", "docente", "discente"
  turma           String? // Preenchido apenas se tipoUsuario == "discente"
  perfilCompleto  Boolean @default(false)
  
  // CORREÇÃO AQUI: 
  presencas    Presenca[]
  feedbacks    Feedback[]
  perguntas    Pergunta[]  // Sistema de perguntas
  votos        Voto[]      // Sistema de votação
  
  @@map("participantes")
}

model Palestra {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  even3Id     Int      @unique
  titulo      String
  descricao   String?
  tipo        String
  local       String?
  
  horarios    HorarioEmbed[]
  palestrantes PalestranteEmbed[]
  
  // CORREÇÃO AQUI: Sem '?'
  presencas    Presenca[]
  feedbacks    Feedback[]
  quizzes      Quiz[]
  perguntas    Pergunta[]  // Sistema de perguntas
  
  // Período de votação (opcional)
  votacaoInicio DateTime?
  votacaoFim    DateTime?
  
  @@map("palestras")
}

type HorarioEmbed {
  id_time    Int?
  date_start String? 
  date_end   String?
}

type PalestranteEmbed {
  even3Id   Int
  nome      String
  bio       String?
}

model Presenca {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  
  participanteId  String   @db.ObjectId
  participante    Participante @relation(fields: [participanteId], references: [id])
  
  palestraId      String   @db.ObjectId
  palestra        Palestra @relation(fields: [palestraId], references: [id])
  
  dataHora        DateTime @default(now())
  sincronizado    Boolean  @default(false)
  
  @@map("presencas")
  @@unique([participanteId, palestraId])
}

model Feedback {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  comentario      String?
  estrelas        Int
  
  participanteId  String   @db.ObjectId
  participante    Participante @relation(fields: [participanteId], references: [id])
  
  palestraId      String   @db.ObjectId
  palestra        Palestra @relation(fields: [palestraId], references: [id])

  @@map("feedbacks")
  @@unique([participanteId, palestraId])
}


model Quiz {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  titulo    String
  descricao String?
  liberado  Boolean @default(false)


  perguntas PerguntaEmbed[]
  tentativas Tentativa[]

  palestraId String @db.ObjectId
  palestra   Palestra @relation(fields: [palestraId], references: [id])

  @@map("quizzes")
}

// Embedded types para perguntas e opcoes dentro do Quiz
type PerguntaEmbed {
  id     String
  texto  String
  pontos Int @default(10)
  opcoes OpcaoEmbed[]
}

type OpcaoEmbed {
  id       String
  texto    String
  eCorreta Boolean @default(false)
}

model Pontuacao {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  participanteId String   @db.ObjectId
  quizId         String?  @db.ObjectId
  pontos         Int

  @@map("pontuacoes")
  @@index([participanteId])
}

model Tentativa {
  id String   @id @default(auto()) @map("_id") @db.ObjectId
  pontosObtidos Int
  enviadoEm     DateTime @default(now())

  participanteId String   @db.ObjectId

  quizId    String   @db.ObjectId
  quiz      Quiz     @relation(fields: [quizId], references: [id])

  @@map("tentativas")
  @@unique([participanteId, quizId])
}

// Sistema de Perguntas e Votação
model Pergunta {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  texto           String   // Contém título + descrição separados por \n\n
  status          String   @default("pendente") // "pendente", "aprovada", "rejeitada"
  
  participanteId  String   @db.ObjectId
  participante    Participante @relation(fields: [participanteId], references: [id])
  
  palestraId      String   @db.ObjectId
  palestra        Palestra @relation(fields: [palestraId], references: [id])
  
  respondida      Boolean  @default(false)
  resposta        String?
  palestranteNome String?
  dataResposta    DateTime?
  
  dataHora        DateTime @default(now())
  
  // Contador desnormalizado para performance (atualizado via service)
  curtidas        Int      @default(0)
  
  // Relações
  votos           Voto[]
  
  @@map("perguntas")
  @@index([palestraId, status])
  @@index([participanteId])
}

model Voto {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  
  participanteId  String   @db.ObjectId
  participante    Participante @relation(fields: [participanteId], references: [id])
  
  perguntaId      String   @db.ObjectId
  pergunta        Pergunta @relation(fields: [perguntaId], references: [id])
  
  dataHora        DateTime @default(now())
  
  @@map("votos")
  @@unique([participanteId, perguntaId]) // Um voto por pessoa por pergunta
  @@index([participanteId])
  @@index([perguntaId])
}